<!DOCTYPE html>
<!--[if IE 8]> 				 <html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->

<head>
  <meta charset="utf-8">
  <title>TryJoinads (II.): Task-based parallelism</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Joinads is a research extension of the F# compiler that makes computation expressions more expressive. In this article, we look how to use the match! notation for working with tasks. The examples include simple parallel map, but also more powerful speculative parallelism.">
  <meta name="author" content="Tomas Petricek">

  <!-- Reference Foundation -->
  <link rel="stylesheet" href="http://tomasp.net/css/foundation.css">
  <script src="cjs/vendor/custom.modernizr.js"></script>

  <link rel="alternate" type="application/rss+xml" href="http://tomasp.net/rss.xml" title="RSS feed for Tomas Petricek's blog">
  <link rel="author" href="https://plus.google.com/109855146654605967051" />
    
  <!-- Reference custom CSS and tooltips -->
  <link type="text/css" rel="stylesheet" href="http://tomasp.net/custom/style.css" />
  <script type="text/javascript" src="http://tomasp.net/custom/tooltips.js"></script>
  <link type="text/css" rel="stylesheet" href="http://tomasp.net/custom/tooltips.css" />
</head>
<body>

   <header id="top-header">
    <div class="row">
      <div class="twelve columns">
        <h1><a href="http://tomasp.net/">Tomas Petricek's blog</a></h1>
        <p>Writing about practical F# coding and programming language research</p>
      </div>
    </div>
  </header>

  <header class="top-bar-header">
    <div class="contain-to-grid sticky">
    <nav class="top-bar">

    <ul class="title-area">
      <li class="name"><h1><a href="#"></a></h1></li>
      <li class="toggle-topbar menu-icon"><a href="#"><span>Menu</span></a></li>
    </ul>
    <section class="top-bar-section">
      <ul class="right">
        <li><a href="http://tomasp.net/blog/index.html">Blog</a></li>
        <li><a href="http://functional-programming.net">Trainings</a></li>
        <li><a href="http://functional-programming.net">Books</a></li>
        <li><a href="http://lanyrd.com/profile/tomasp">Talks</a></li>
        <li><a href="http://www.cl.cam.ac.uk/~tp322">Research & Teaching</a></li>
      </ul>
    </section>

    </nav></div>
  </header>
  
  
<div class="row">
	<div class="large-8 columns main-content">
    <content>
      
<h1>TryJoinads (II.): Task-based parallelism</h1>
<p>The implementation of joinad operations for the <code>Task&lt;'T&gt;</code> type is quite similar to the 
implementation of <code>Async&lt;'T&gt;</code>, because the two types have similar properties. They both
produce at most one value (or an exception) and they both take some time to complete.</p>

<p>Just like for asynchronous workflows, pattern matching on multiple computations using 
<code>match!</code> gives us a parallel composition (with the two tasks running in parallel) and
choice between clauses is non-deterministic, depending on which clause completes first.</p>

<p>Unlike asynchronous workflows, the <code>Task&lt;'T&gt;</code> type does not require any support for
aliasing. A value of type <code>Task&lt;'T&gt;</code> represents a <em>running</em> computation that can be
accessed from multiple parts of program. In this sense, the type <code>Async&lt;'T&gt;</code> is more
similar to a function <code>unit -&gt; Task&lt;'T&gt;</code> than to the type <code>Task&lt;'T&gt;</code> itself.</p>

<p>The key difference between tasks and asynchronous workflows is that the latter provides
better support for writing non-blocking computations that involve <em>asynchronous</em> 
long-running operations such as I/O or waiting for a certain event. Tasks are more
suitable for high-performance CPU-intensive computations.</p>

<p><em><strong>Note:</strong> This blog post is a re-publication of a tutorial from the <a href="http://tryjoinads.org">TryJoinads.org</a>
web page. If you read the article there, you can run the examples interactively
and experiment with them: <a href="http://tryjoinads.org/index.html?use/tasks.html">view the article on TryJoinads</a>.</em></p>

<h2>Parallel list processing</h2>

<p>The main example in this article is a tree processing function that can be used to test
whether all values in leafs satisfy a given predicate. However, we'll build the 
example step-by-step, exploring several other examples along the way.</p>

<p>To generate inputs for testing, we will calculate a list containing several large prime
numbers. We will use functional <code>map</code> and <code>filter</code> combinators, but we first implement
parallel version of <code>map</code> (in practice, this is already available in F# libraries or in
the <a href="http://fsharppowerpack.codeplex.com/">F# PowerPack</a>, but it is an interesting example
of using joinads:</p>

<pre class="fssnip">
<span class="k">open</span> <span onmouseout="hideTip(event, 'ft1', 1)" onmouseover="showTip(event, 'ft1', 1)" class="i">System</span><span class="o">.</span><span onmouseout="hideTip(event, 'ft2', 2)" onmouseover="showTip(event, 'ft2', 2)" class="i">Threading</span><span class="o">.</span><span onmouseout="hideTip(event, 'ft3', 3)" onmouseover="showTip(event, 'ft3', 3)" class="i">Tasks</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'ft4', 4)" onmouseover="showTip(event, 'ft4', 4)" class="i">FSharp</span><span class="o">.</span><span onmouseout="hideTip(event, 'ft5', 5)" onmouseover="showTip(event, 'ft5', 5)" class="i">Extensions</span><span class="o">.</span><span onmouseout="hideTip(event, 'ft6', 6)" onmouseover="showTip(event, 'ft6', 6)" class="i">Joinads</span>

<span class="c">/// Applies the specified function to all </span>
<span class="c">/// elements of the input list in parallel.</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'ft7', 7)" onmouseover="showTip(event, 'ft7', 7)" class="i">parallelMap</span> (<span onmouseout="hideTip(event, 'ft8', 8)" onmouseover="showTip(event, 'ft8', 8)" class="i">f</span><span class="o">:</span><span class="o">&#39;</span><span class="i">T</span> <span class="k">-&gt;</span> <span class="o">&#39;</span><span class="i">R</span>) <span onmouseout="hideTip(event, 'ft9', 9)" onmouseover="showTip(event, 'ft9', 9)" class="i">input</span> <span class="o">=</span> 
  <span class="c">// Recursively process list and spawn tasks</span>
  <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'ft10', 10)" onmouseover="showTip(event, 'ft10', 10)" class="i">loop</span> <span onmouseout="hideTip(event, 'ft9', 11)" onmouseover="showTip(event, 'ft9', 11)" class="i">input</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'ft11', 12)" onmouseover="showTip(event, 'ft11', 12)" class="i">future</span> {
    <span class="k">match</span> <span onmouseout="hideTip(event, 'ft9', 13)" onmouseover="showTip(event, 'ft9', 13)" class="i">input</span> <span class="k">with</span> 
    | [] <span class="k">-&gt;</span> <span class="k">return</span> []
    | <span onmouseout="hideTip(event, 'ft12', 14)" onmouseover="showTip(event, 'ft12', 14)" class="i">x</span><span class="o">::</span><span onmouseout="hideTip(event, 'ft13', 15)" onmouseover="showTip(event, 'ft13', 15)" class="i">xs</span> <span class="k">-&gt;</span> 
       <span class="c">// Process current element &amp; the rest of the list</span>
       <span class="k">match!</span> <span onmouseout="hideTip(event, 'ft11', 16)" onmouseover="showTip(event, 'ft11', 16)" class="i">future</span> { <span class="k">return</span> <span onmouseout="hideTip(event, 'ft8', 17)" onmouseover="showTip(event, 'ft8', 17)" class="i">f</span> <span onmouseout="hideTip(event, 'ft12', 18)" onmouseover="showTip(event, 'ft12', 18)" class="i">x</span> }, <span onmouseout="hideTip(event, 'ft10', 19)" onmouseover="showTip(event, 'ft10', 19)" class="i">loop</span> <span onmouseout="hideTip(event, 'ft13', 20)" onmouseover="showTip(event, 'ft13', 20)" class="i">xs</span> <span class="k">with</span>
       | <span onmouseout="hideTip(event, 'ft14', 21)" onmouseover="showTip(event, 'ft14', 21)" class="i">y</span>, <span onmouseout="hideTip(event, 'ft15', 22)" onmouseover="showTip(event, 'ft15', 22)" class="i">ys</span> <span class="k">-&gt;</span> <span class="k">return</span> <span onmouseout="hideTip(event, 'ft14', 23)" onmouseover="showTip(event, 'ft14', 23)" class="i">y</span><span class="o">::</span><span onmouseout="hideTip(event, 'ft15', 24)" onmouseover="showTip(event, 'ft15', 24)" class="i">ys</span> }

  <span class="c">// Start the work and wait until it completes</span>
  (<span onmouseout="hideTip(event, 'ft10', 25)" onmouseover="showTip(event, 'ft10', 25)" class="i">loop</span> <span onmouseout="hideTip(event, 'ft9', 26)" onmouseover="showTip(event, 'ft9', 26)" class="i">input</span>)<span class="o">.</span><span class="i">Result</span></pre>


<p>The function <code>parallelMap</code> contains a nested recursive function <code>loop</code> that returns
a task, which is processing a part of the list in parallel. The declaration of 
<code>loop</code> uses a computation builder <code>future { ... }</code> (which is defined in the 
<code>FSharp.Extensions.Joinads</code> namespace).</p>

<p>The <code>loop</code> function uses ordinary <code>match</code> to handle the end of the list. If the
list is non-empty, it uses <code>match!</code> to perform two tasks in parallel:</p>

<ul>
<li>First, it runs a computation that evaluates <code>f x</code></li>
<li>Second, it recursively calls <code>loop xs</code> to process the rest of the list</li>
</ul>

<p>When both computations complete, the body of the clause constructs a list
to be returned. The return type of <code>loop</code> is <code>Task&lt;list&lt;'T&gt;&gt;</code>, so the
body of <code>parallelMap</code> uses the <code>Result</code> property to obtain the processed list.</p>

<p>The following snippet defines a function that tests whether a number is
prime and compares the performance of sequential and parallel <code>map</code> function:</p>

<pre class="fssnip">
<span class="c">// Create a list containing 1000 big numbers</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'ft16', 27)" onmouseover="showTip(event, 'ft16', 27)" class="i">nums</span> <span class="o">=</span> [ <span class="k">for</span> <span onmouseout="hideTip(event, 'ft17', 28)" onmouseover="showTip(event, 'ft17', 28)" class="i">i</span> <span class="k">in</span> <span class="n">0L</span> <span class="o">..</span> <span class="n">1000L</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'ft17', 29)" onmouseover="showTip(event, 'ft17', 29)" class="i">i</span> <span class="o">+</span> <span class="n">5000000000000L</span> ]

<span class="c">/// Tests whether the specified 64 bit int is a prime</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'ft18', 30)" onmouseover="showTip(event, 'ft18', 30)" class="i">isPrime</span> <span onmouseout="hideTip(event, 'ft19', 31)" onmouseover="showTip(event, 'ft19', 31)" class="i">num</span> <span class="o">=</span> 
  <span onmouseout="hideTip(event, 'ft20', 32)" onmouseover="showTip(event, 'ft20', 32)" class="i">seq</span> { <span class="n">2L</span> <span class="o">..</span> <span onmouseout="hideTip(event, 'ft21', 33)" onmouseover="showTip(event, 'ft21', 33)" class="i">int64</span> (<span onmouseout="hideTip(event, 'ft22', 34)" onmouseover="showTip(event, 'ft22', 34)" class="i">sqrt</span> (<span onmouseout="hideTip(event, 'ft23', 35)" onmouseover="showTip(event, 'ft23', 35)" class="i">float</span> <span onmouseout="hideTip(event, 'ft19', 36)" onmouseover="showTip(event, 'ft19', 36)" class="i">num</span>)) } 
  <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'ft24', 37)" onmouseover="showTip(event, 'ft24', 37)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'ft25', 38)" onmouseover="showTip(event, 'ft25', 38)" class="i">forall</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'ft26', 39)" onmouseover="showTip(event, 'ft26', 39)" class="i">div</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'ft19', 40)" onmouseover="showTip(event, 'ft19', 40)" class="i">num</span> <span class="o">%</span> <span onmouseout="hideTip(event, 'ft26', 41)" onmouseover="showTip(event, 'ft26', 41)" class="i">div</span> <span class="o">&lt;&gt;</span> <span class="n">0L</span>)

<span class="c">// Turn on the timing and compare the performance</span>
<span class="prep">#time</span>
<span onmouseout="hideTip(event, 'ft27', 42)" onmouseover="showTip(event, 'ft27', 42)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'ft28', 43)" onmouseover="showTip(event, 'ft28', 43)" class="i">map</span> <span onmouseout="hideTip(event, 'ft18', 44)" onmouseover="showTip(event, 'ft18', 44)" class="i">isPrime</span> <span onmouseout="hideTip(event, 'ft16', 45)" onmouseover="showTip(event, 'ft16', 45)" class="i">nums</span>
<span onmouseout="hideTip(event, 'ft7', 46)" onmouseover="showTip(event, 'ft7', 46)" class="i">parallelMap</span> <span onmouseout="hideTip(event, 'ft18', 47)" onmouseover="showTip(event, 'ft18', 47)" class="i">isPrime</span> <span onmouseout="hideTip(event, 'ft16', 48)" onmouseover="showTip(event, 'ft16', 48)" class="i">nums</span></pre>


<p>When you load the code in F# Interactive, you can select and run the <code>#time</code> 
directive to enable simple performance measuring. F# Interactive then prints
the result of every entered command, together with the time it took to calculate
it. On the author's machine, the time needed to run the sequential version is
about 8 seconds and the time of the parallel version is about 4.5 seconds.</p>

<h2>Building a ballanced tree</h2>

<p>Before we can look at tree processing, we need to define a list type and
we need to write a function for constructing lists. The following snippet shows
a standard binary tree declaration together with a function <code>ballancedOfList</code> that
creates ballanced tree from a non-empty list:</p>

<pre class="fssnip">
<span class="k">type</span> <span onmouseout="hideTip(event, 'ft29', 49)" onmouseover="showTip(event, 'ft29', 49)" class="i">Tree</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">T</span><span class="o">&gt;</span> <span class="o">=</span> 
  | <span onmouseout="hideTip(event, 'ft30', 50)" onmouseover="showTip(event, 'ft30', 50)" class="i">Leaf</span> <span class="k">of</span> <span class="o">&#39;</span><span class="i">T</span> 
  | <span onmouseout="hideTip(event, 'ft31', 51)" onmouseover="showTip(event, 'ft31', 51)" class="i">Node</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'ft29', 52)" onmouseover="showTip(event, 'ft29', 52)" class="i">Tree</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">T</span><span class="o">&gt;</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'ft29', 53)" onmouseover="showTip(event, 'ft29', 53)" class="i">Tree</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">T</span><span class="o">&gt;</span>

<span class="c">/// Creates a ballanced tree from a non-empty list</span>
<span class="c">/// (odd elements are added to the left and even to the right)</span>
<span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'ft32', 54)" onmouseover="showTip(event, 'ft32', 54)" class="i">ballancedOfList</span> <span onmouseout="hideTip(event, 'ft33', 55)" onmouseover="showTip(event, 'ft33', 55)" class="i">list</span> <span class="o">=</span>
  <span class="k">match</span> <span onmouseout="hideTip(event, 'ft33', 56)" onmouseover="showTip(event, 'ft33', 56)" class="i">list</span> <span class="k">with</span> 
  | [] <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'ft34', 57)" onmouseover="showTip(event, 'ft34', 57)" class="i">failwith</span> <span class="s">&quot;</span><span class="s">Cannot</span><span class="s"> </span><span class="s">create</span><span class="s"> </span><span class="s">tree</span><span class="s"> </span><span class="s">of</span><span class="s"> </span><span class="s">empty</span><span class="s"> </span><span class="s">list</span><span class="s">&quot;</span>
  | [<span onmouseout="hideTip(event, 'ft35', 58)" onmouseover="showTip(event, 'ft35', 58)" class="i">n</span>] <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'ft30', 59)" onmouseover="showTip(event, 'ft30', 59)" class="i">Leaf</span> <span onmouseout="hideTip(event, 'ft35', 60)" onmouseover="showTip(event, 'ft35', 60)" class="i">n</span>
  | _ <span class="k">-&gt;</span> 
      <span class="c">// Split the elements into odd and even using their index</span>
      <span class="k">let</span> <span onmouseout="hideTip(event, 'ft36', 61)" onmouseover="showTip(event, 'ft36', 61)" class="i">left</span>, <span onmouseout="hideTip(event, 'ft37', 62)" onmouseover="showTip(event, 'ft37', 62)" class="i">right</span> <span class="o">=</span>
        <span onmouseout="hideTip(event, 'ft33', 63)" onmouseover="showTip(event, 'ft33', 63)" class="i">list</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'ft27', 64)" onmouseover="showTip(event, 'ft27', 64)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'ft38', 65)" onmouseover="showTip(event, 'ft38', 65)" class="i">mapi</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'ft39', 66)" onmouseover="showTip(event, 'ft39', 66)" class="i">i</span> <span onmouseout="hideTip(event, 'ft40', 67)" onmouseover="showTip(event, 'ft40', 67)" class="i">v</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'ft39', 68)" onmouseover="showTip(event, 'ft39', 68)" class="i">i</span>, <span onmouseout="hideTip(event, 'ft40', 69)" onmouseover="showTip(event, 'ft40', 69)" class="i">v</span>)
             <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'ft27', 70)" onmouseover="showTip(event, 'ft27', 70)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'ft41', 71)" onmouseover="showTip(event, 'ft41', 71)" class="i">partition</span> (<span class="k">fun</span> (<span onmouseout="hideTip(event, 'ft39', 72)" onmouseover="showTip(event, 'ft39', 72)" class="i">i</span>, <span onmouseout="hideTip(event, 'ft40', 73)" onmouseover="showTip(event, 'ft40', 73)" class="i">v</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'ft39', 74)" onmouseover="showTip(event, 'ft39', 74)" class="i">i</span><span class="o">%</span><span class="n">2</span> <span class="o">=</span> <span class="n">0</span>)
      <span class="c">// Create ballanced trees for both parts</span>
      <span class="k">let</span> <span onmouseout="hideTip(event, 'ft42', 75)" onmouseover="showTip(event, 'ft42', 75)" class="i">left</span>, <span onmouseout="hideTip(event, 'ft43', 76)" onmouseover="showTip(event, 'ft43', 76)" class="i">right</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'ft27', 77)" onmouseover="showTip(event, 'ft27', 77)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'ft28', 78)" onmouseover="showTip(event, 'ft28', 78)" class="i">map</span> <span onmouseout="hideTip(event, 'ft44', 79)" onmouseover="showTip(event, 'ft44', 79)" class="i">snd</span> <span onmouseout="hideTip(event, 'ft36', 80)" onmouseover="showTip(event, 'ft36', 80)" class="i">left</span>, <span onmouseout="hideTip(event, 'ft27', 81)" onmouseover="showTip(event, 'ft27', 81)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'ft28', 82)" onmouseover="showTip(event, 'ft28', 82)" class="i">map</span> <span onmouseout="hideTip(event, 'ft44', 83)" onmouseover="showTip(event, 'ft44', 83)" class="i">snd</span> <span onmouseout="hideTip(event, 'ft43', 84)" onmouseover="showTip(event, 'ft43', 84)" class="i">right</span>
      <span onmouseout="hideTip(event, 'ft31', 85)" onmouseover="showTip(event, 'ft31', 85)" class="i">Node</span>(<span onmouseout="hideTip(event, 'ft32', 86)" onmouseover="showTip(event, 'ft32', 86)" class="i">ballancedOfList</span> <span onmouseout="hideTip(event, 'ft42', 87)" onmouseover="showTip(event, 'ft42', 87)" class="i">left</span>, <span onmouseout="hideTip(event, 'ft32', 88)" onmouseover="showTip(event, 'ft32', 88)" class="i">ballancedOfList</span> <span onmouseout="hideTip(event, 'ft43', 89)" onmouseover="showTip(event, 'ft43', 89)" class="i">right</span>)</pre>


<p>The function is quite simple and it is only shown to make the sample complete.
We use it to construct two trees that we'll later want to process. The first
tree is generated by taking all primes from the <code>nums</code> list shown earlier and
the other contains several additional non-prime numbers:</p>

<pre class="fssnip">
<span class="c">// Create a list with large prime numbers</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'ft45', 90)" onmouseover="showTip(event, 'ft45', 90)" class="i">primes</span> <span class="o">=</span> 
  <span onmouseout="hideTip(event, 'ft16', 91)" onmouseover="showTip(event, 'ft16', 91)" class="i">nums</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'ft7', 92)" onmouseover="showTip(event, 'ft7', 92)" class="i">parallelMap</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'ft46', 93)" onmouseover="showTip(event, 'ft46', 93)" class="i">v</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'ft18', 94)" onmouseover="showTip(event, 'ft18', 94)" class="i">isPrime</span> <span onmouseout="hideTip(event, 'ft46', 95)" onmouseover="showTip(event, 'ft46', 95)" class="i">v</span>, <span onmouseout="hideTip(event, 'ft46', 96)" onmouseover="showTip(event, 'ft46', 96)" class="i">v</span>) 
       <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'ft27', 97)" onmouseover="showTip(event, 'ft27', 97)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'ft47', 98)" onmouseover="showTip(event, 'ft47', 98)" class="i">filter</span> <span onmouseout="hideTip(event, 'ft48', 99)" onmouseover="showTip(event, 'ft48', 99)" class="i">fst</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'ft27', 100)" onmouseover="showTip(event, 'ft27', 100)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'ft28', 101)" onmouseover="showTip(event, 'ft28', 101)" class="i">map</span> <span onmouseout="hideTip(event, 'ft44', 102)" onmouseover="showTip(event, 'ft44', 102)" class="i">snd</span>
<span class="c">// Create a list with some additional non-primes</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'ft49', 103)" onmouseover="showTip(event, 'ft49', 103)" class="i">mixed</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'ft45', 104)" onmouseover="showTip(event, 'ft45', 104)" class="i">primes</span> <span class="o">@</span> [ <span class="n">2L</span> <span class="o">..</span> <span class="n">20L</span> ]

<span class="c">// Created ballanced trees from both lists</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'ft50', 105)" onmouseover="showTip(event, 'ft50', 105)" class="i">primeTree</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'ft32', 106)" onmouseover="showTip(event, 'ft32', 106)" class="i">ballancedOfList</span> <span onmouseout="hideTip(event, 'ft45', 107)" onmouseover="showTip(event, 'ft45', 107)" class="i">primes</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'ft51', 108)" onmouseover="showTip(event, 'ft51', 108)" class="i">mixedTree</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'ft32', 109)" onmouseover="showTip(event, 'ft32', 109)" class="i">ballancedOfList</span> <span onmouseout="hideTip(event, 'ft49', 110)" onmouseover="showTip(event, 'ft49', 110)" class="i">mixed</span></pre>


<p>The <code>primeTree</code> tree contains only large prime numbers, so checking if it
contains only prime numbers will take relatively long. The <code>mixedTree</code> contains
several additional numbers, some of them are not primes. This means that
running <code>isPrime</code> on all of the values would take longer, but if we can
return the result immediately after we find a non-prime, the processing is 
likely to complete quite quickly.</p>

<h2>Parallel tree processing</h2>

<p>Let's now implement a <code>forall</code> function that takes a tree and a predicate
and tests whether the predicate holds for all leafs. We use the <code>future { ... }</code>
computation builder and we use <code>match!</code> to handle the <code>Node</code> case by 
checking both sub-trees in parallel:</p>

<pre class="fssnip">
<span class="c">/// Checks whether the specified predicate &#39;f&#39;</span>
<span class="c">/// holds for all Leaf elements of the tree.</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'ft52', 111)" onmouseover="showTip(event, 'ft52', 111)" class="i">forall</span> <span onmouseout="hideTip(event, 'ft53', 112)" onmouseover="showTip(event, 'ft53', 112)" class="i">f</span> <span onmouseout="hideTip(event, 'ft54', 113)" onmouseover="showTip(event, 'ft54', 113)" class="i">tree</span> <span class="o">=</span> 
  <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'ft55', 114)" onmouseover="showTip(event, 'ft55', 114)" class="i">loop</span> <span onmouseout="hideTip(event, 'ft54', 115)" onmouseover="showTip(event, 'ft54', 115)" class="i">tree</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'ft11', 116)" onmouseover="showTip(event, 'ft11', 116)" class="i">future</span> { 
    <span class="k">match</span> <span onmouseout="hideTip(event, 'ft54', 117)" onmouseover="showTip(event, 'ft54', 117)" class="i">tree</span> <span class="k">with</span>
    | <span onmouseout="hideTip(event, 'ft30', 118)" onmouseover="showTip(event, 'ft30', 118)" class="i">Leaf</span> <span onmouseout="hideTip(event, 'ft40', 119)" onmouseover="showTip(event, 'ft40', 119)" class="i">v</span> <span class="k">-&gt;</span> <span class="k">return</span> <span onmouseout="hideTip(event, 'ft53', 120)" onmouseover="showTip(event, 'ft53', 120)" class="i">f</span> <span onmouseout="hideTip(event, 'ft40', 121)" onmouseover="showTip(event, 'ft40', 121)" class="i">v</span> 
    | <span onmouseout="hideTip(event, 'ft31', 122)" onmouseover="showTip(event, 'ft31', 122)" class="i">Node</span>(<span onmouseout="hideTip(event, 'ft56', 123)" onmouseover="showTip(event, 'ft56', 123)" class="i">left</span>, <span onmouseout="hideTip(event, 'ft57', 124)" onmouseover="showTip(event, 'ft57', 124)" class="i">right</span>) <span class="k">-&gt;</span>
        <span class="c">// Process left and right branch in parallel</span>
        <span class="k">match!</span> <span onmouseout="hideTip(event, 'ft55', 125)" onmouseover="showTip(event, 'ft55', 125)" class="i">loop</span> <span onmouseout="hideTip(event, 'ft56', 126)" onmouseover="showTip(event, 'ft56', 126)" class="i">left</span>, <span onmouseout="hideTip(event, 'ft55', 127)" onmouseover="showTip(event, 'ft55', 127)" class="i">loop</span> <span onmouseout="hideTip(event, 'ft57', 128)" onmouseover="showTip(event, 'ft57', 128)" class="i">right</span> <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'ft58', 129)" onmouseover="showTip(event, 'ft58', 129)" class="i">l</span>, <span onmouseout="hideTip(event, 'ft59', 130)" onmouseover="showTip(event, 'ft59', 130)" class="i">r</span> <span class="k">-&gt;</span> <span class="k">return</span> <span onmouseout="hideTip(event, 'ft58', 131)" onmouseover="showTip(event, 'ft58', 131)" class="i">l</span> <span class="o">&amp;&amp;</span> <span onmouseout="hideTip(event, 'ft59', 132)" onmouseover="showTip(event, 'ft59', 132)" class="i">r</span> }
  <span class="c">// Start the recursive processing &amp; wait for the result</span>
  (<span onmouseout="hideTip(event, 'ft55', 133)" onmouseover="showTip(event, 'ft55', 133)" class="i">loop</span> <span onmouseout="hideTip(event, 'ft54', 134)" onmouseover="showTip(event, 'ft54', 134)" class="i">tree</span>)<span class="o">.</span><span class="i">Result</span>

<span class="c">// Test processing on two sample trees</span>
<span onmouseout="hideTip(event, 'ft52', 135)" onmouseover="showTip(event, 'ft52', 135)" class="i">forall</span> <span onmouseout="hideTip(event, 'ft18', 136)" onmouseover="showTip(event, 'ft18', 136)" class="i">isPrime</span> <span onmouseout="hideTip(event, 'ft51', 137)" onmouseover="showTip(event, 'ft51', 137)" class="i">mixedTree</span>
<span onmouseout="hideTip(event, 'ft52', 138)" onmouseover="showTip(event, 'ft52', 138)" class="i">forall</span> <span onmouseout="hideTip(event, 'ft18', 139)" onmouseover="showTip(event, 'ft18', 139)" class="i">isPrime</span> <span onmouseout="hideTip(event, 'ft50', 140)" onmouseover="showTip(event, 'ft50', 140)" class="i">primeTree</span></pre>


<p>If you run the processing on both <code>mixedTree</code> and <code>primeTree</code>, they will 
take similarly long time to complete. However, a sequential version of
the function would be faster for <code>mixedTree</code>, because it would return
<code>false</code> immediately after finding the first non-prime number.</p>

<h3>Adding short-circuiting</h3>

<p>Implementing the same functionality using <code>Task&lt;'T&gt;</code> sounds difficult, 
but using joinads, the problem becomes quite simple. We add two additional 
clauses that handle the case when one branch completes returning <code>false</code>.</p>

<p>Aside from this simple change, we also need to make sure that all remaining
tasks, which are not required to complete, get cancelled. 
The cancellation is implemented by creating a .NET <code>CancellationTokenSource</code> 
before starting the recursive processing. In the body of <code>loop</code> we then check
if the processing has completed and we throw an exception if it has:</p>

<pre class="fssnip">
<span class="k">open</span> <span onmouseout="hideTip(event, 'ft1', 141)" onmouseover="showTip(event, 'ft1', 141)" class="i">System</span><span class="o">.</span><span onmouseout="hideTip(event, 'ft2', 142)" onmouseover="showTip(event, 'ft2', 142)" class="i">Threading</span>

<span class="c">/// Behaves like previous &#39;forall&#39; function, but returns</span>
<span class="c">/// immediately when one of the branches returns &#39;false&#39;</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'ft60', 143)" onmouseover="showTip(event, 'ft60', 143)" class="i">forall</span> <span onmouseout="hideTip(event, 'ft53', 144)" onmouseover="showTip(event, 'ft53', 144)" class="i">f</span> <span onmouseout="hideTip(event, 'ft54', 145)" onmouseover="showTip(event, 'ft54', 145)" class="i">tree</span> <span class="o">=</span> 
  <span class="c">// Create cancellation token for checking</span>
  <span class="k">let</span> <span onmouseout="hideTip(event, 'ft61', 146)" onmouseover="showTip(event, 'ft61', 146)" class="i">cts</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'ft62', 147)" onmouseover="showTip(event, 'ft62', 147)" class="i">CancellationTokenSource</span>()
  <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'ft55', 148)" onmouseover="showTip(event, 'ft55', 148)" class="i">loop</span> <span onmouseout="hideTip(event, 'ft54', 149)" onmouseover="showTip(event, 'ft54', 149)" class="i">tree</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'ft11', 150)" onmouseover="showTip(event, 'ft11', 150)" class="i">future</span> { 
    <span class="c">// Stop processing if the function already returned</span>
    <span class="k">if</span> <span onmouseout="hideTip(event, 'ft61', 151)" onmouseover="showTip(event, 'ft61', 151)" class="i">cts</span><span class="o">.</span><span onmouseout="hideTip(event, 'ft63', 152)" onmouseover="showTip(event, 'ft63', 152)" class="i">Token</span><span class="o">.</span><span onmouseout="hideTip(event, 'ft64', 153)" onmouseover="showTip(event, 'ft64', 153)" class="i">IsCancellationRequested</span> <span class="k">then</span> 
        <span onmouseout="hideTip(event, 'ft34', 154)" onmouseover="showTip(event, 'ft34', 154)" class="i">failwith</span> <span class="s">&quot;</span><span class="s">cancelled</span><span class="s">&quot;</span>
    <span class="k">match</span> <span onmouseout="hideTip(event, 'ft54', 155)" onmouseover="showTip(event, 'ft54', 155)" class="i">tree</span> <span class="k">with</span>
    | <span onmouseout="hideTip(event, 'ft30', 156)" onmouseover="showTip(event, 'ft30', 156)" class="i">Leaf</span> <span onmouseout="hideTip(event, 'ft40', 157)" onmouseover="showTip(event, 'ft40', 157)" class="i">v</span> <span class="k">-&gt;</span> <span class="k">return</span> <span onmouseout="hideTip(event, 'ft53', 158)" onmouseover="showTip(event, 'ft53', 158)" class="i">f</span> <span onmouseout="hideTip(event, 'ft40', 159)" onmouseover="showTip(event, 'ft40', 159)" class="i">v</span> 
    | <span onmouseout="hideTip(event, 'ft31', 160)" onmouseover="showTip(event, 'ft31', 160)" class="i">Node</span>(<span onmouseout="hideTip(event, 'ft56', 161)" onmouseover="showTip(event, 'ft56', 161)" class="i">left</span>, <span onmouseout="hideTip(event, 'ft57', 162)" onmouseover="showTip(event, 'ft57', 162)" class="i">right</span>) <span class="k">-&gt;</span>
        <span class="k">match!</span> <span onmouseout="hideTip(event, 'ft55', 163)" onmouseover="showTip(event, 'ft55', 163)" class="i">loop</span> <span onmouseout="hideTip(event, 'ft56', 164)" onmouseover="showTip(event, 'ft56', 164)" class="i">left</span>, <span onmouseout="hideTip(event, 'ft55', 165)" onmouseover="showTip(event, 'ft55', 165)" class="i">loop</span> <span onmouseout="hideTip(event, 'ft57', 166)" onmouseover="showTip(event, 'ft57', 166)" class="i">right</span> <span class="k">with</span>
        | <span class="k">false</span>, <span class="o">?</span> <span class="k">-&gt;</span> <span class="k">return</span> <span class="k">false</span>
        | <span class="o">?</span>, <span class="k">false</span> <span class="k">-&gt;</span> <span class="k">return</span> <span class="k">false</span>
        | <span onmouseout="hideTip(event, 'ft58', 167)" onmouseover="showTip(event, 'ft58', 167)" class="i">l</span>, <span onmouseout="hideTip(event, 'ft59', 168)" onmouseover="showTip(event, 'ft59', 168)" class="i">r</span> <span class="k">-&gt;</span> <span class="k">return</span> <span onmouseout="hideTip(event, 'ft58', 169)" onmouseover="showTip(event, 'ft58', 169)" class="i">l</span> <span class="o">&amp;&amp;</span> <span onmouseout="hideTip(event, 'ft59', 170)" onmouseover="showTip(event, 'ft59', 170)" class="i">r</span> }

  <span class="c">// Wait for the result &amp; cancel all pending work</span>
  <span class="k">let</span> <span onmouseout="hideTip(event, 'ft65', 171)" onmouseover="showTip(event, 'ft65', 171)" class="i">res</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'ft55', 172)" onmouseover="showTip(event, 'ft55', 172)" class="i">loop</span> <span onmouseout="hideTip(event, 'ft54', 173)" onmouseover="showTip(event, 'ft54', 173)" class="i">tree</span>)<span class="o">.</span><span class="i">Result</span>
  <span onmouseout="hideTip(event, 'ft61', 174)" onmouseover="showTip(event, 'ft61', 174)" class="i">cts</span><span class="o">.</span><span onmouseout="hideTip(event, 'ft66', 175)" onmouseover="showTip(event, 'ft66', 175)" class="i">Cancel</span>()
  <span onmouseout="hideTip(event, 'ft65', 176)" onmouseover="showTip(event, 'ft65', 176)" class="i">res</span>

<span class="c">// Processing &#39;mixedTree&#39; is significanlty faster,</span>
<span class="c">// because it returns after first non-prime is found!</span>
<span onmouseout="hideTip(event, 'ft60', 177)" onmouseover="showTip(event, 'ft60', 177)" class="i">forall</span> <span onmouseout="hideTip(event, 'ft18', 178)" onmouseover="showTip(event, 'ft18', 178)" class="i">isPrime</span> <span onmouseout="hideTip(event, 'ft51', 179)" onmouseover="showTip(event, 'ft51', 179)" class="i">mixedTree</span>
<span onmouseout="hideTip(event, 'ft60', 180)" onmouseover="showTip(event, 'ft60', 180)" class="i">forall</span> <span onmouseout="hideTip(event, 'ft18', 181)" onmouseover="showTip(event, 'ft18', 181)" class="i">isPrime</span> <span onmouseout="hideTip(event, 'ft50', 182)" onmouseover="showTip(event, 'ft50', 182)" class="i">primeTree</span></pre>


<p>The changes required to implement short-circuiting are quite small. As already
mentioned, we added two clauses with patterns <code>false, ?</code> and <code>?, false</code>. These
will match when one of the computation completes and returns <code>false</code> while the
other is still running. When that happens, the function <code>loop</code> can return the
final result, but the other task may still continue running.</p>

<p>To actually save CPU power, we need to cancel the other task. This is done using
the standard .NET mechanism. After the task that processes the entire tree 
completes, we call <code>cts.Cancel()</code> to trigger the cancellation. All tasks that
are started from that point will throw an exception (which is okay, because 
non-deterministic choice ignores exceptions if the first computation succeeds).</p>

<p>As a result, the processing of <code>mixedTree</code> is now significantly faster than the
processing of <code>primeTree</code>. On the author's machine, the first one requires about
0.3s, while the second takes 4 seconds to complete. You can easily test the performance
for different inputs yourself using the <code>#time</code> directive.</p>

<h2>Summary</h2>

<p>In principle, the implementation of joinad operations for the <code>Task&lt;'T&gt;</code> type is
very similar to the implementation for asynchronous workflows as discussed in the
<a href="http://tomasp.net/blog/joinads-async-prog.aspx">previous article</a>. The main difference is that the underlying type is
different - tasks are designed for CPU-intensive computations. Therefore the applications
in this article were quite different. We used tasks to write a parallel <code>map</code>
operation for lists and then to implement <code>forall</code> function for trees. The second
was particularly interesting, because joinads make it very easy to implement 
<em>shortcircuiting</em> behaviour thanks to the non-deterministic choice between clauses.</p>


<!-- HTML for Tool Tips -->

<div class="tip" id="ft1">namespace System</div>
<div class="tip" id="ft2">namespace System.Threading</div>
<div class="tip" id="ft3">namespace System.Threading.Tasks</div>
<div class="tip" id="ft4">namespace FSharp</div>
<div class="tip" id="ft5">namespace FSharp.Extensions</div>
<div class="tip" id="ft6">namespace FSharp.Extensions.Joinads</div>
<div class="tip" id="ft7">val parallelMap : (&#39;T -&gt; &#39;R) -&gt; &#39;T list -&gt; &#39;R list<br /><br />Full name: TryJoinads.parallelMap<br /><em><br /><br />&#160;Applies the specified function to all <br />&#160;elements of the input list in parallel.</em></div>
<div class="tip" id="ft8">val f : (&#39;T -&gt; &#39;R)</div>
<div class="tip" id="ft9">val input : &#39;T list<br />&#160;&#160;type: &#39;T list<br /></div>
<div class="tip" id="ft10">val loop : (&#39;T list -&gt; Task&lt;&#39;R list&gt;)</div>
<div class="tip" id="ft11">val future : FutureBuilder<br /><br />Full name: FSharp.Extensions.Joinads.TopLevelValues.future</div>
<div class="tip" id="ft12">val x : &#39;T</div>
<div class="tip" id="ft13">val xs : &#39;T list<br />&#160;&#160;type: &#39;T list<br /></div>
<div class="tip" id="ft14">val y : &#39;R</div>
<div class="tip" id="ft15">val ys : &#39;R list<br />&#160;&#160;type: &#39;R list<br /></div>
<div class="tip" id="ft16">val nums : int64 list<br /><br />Full name: TryJoinads.nums<br />&#160;&#160;type: int64 list<br /></div>
<div class="tip" id="ft17">val i : int64<br />&#160;&#160;type: int64<br />&#160;&#160;inherits: System.ValueType<br /></div>
<div class="tip" id="ft18">val isPrime : int64 -&gt; bool<br /><br />Full name: TryJoinads.isPrime<br /><em><br /><br />&#160;Tests whether the specified 64 bit int is a prime</em></div>
<div class="tip" id="ft19">val num : int64<br />&#160;&#160;type: int64<br />&#160;&#160;inherits: System.ValueType<br /></div>
<div class="tip" id="ft20">Multiple items<br />val seq : seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Core.Operators.seq<br /><br />--------------------<br />type seq&lt;&#39;T&gt; = System.Collections.Generic.IEnumerable&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.seq&lt;_&gt;<br />&#160;&#160;type: seq&lt;&#39;T&gt;<br />&#160;&#160;inherits: System.Collections.IEnumerable<br /></div>
<div class="tip" id="ft21">Multiple items<br />val int64 : &#39;T -&gt; int64 (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.int64<br /><br />--------------------<br />type int64&lt;&#39;Measure&gt; = int64<br /><br />Full name: Microsoft.FSharp.Core.int64&lt;_&gt;<br />&#160;&#160;type: int64&lt;&#39;Measure&gt;<br />&#160;&#160;inherits: System.ValueType<br /><br /><br />--------------------<br />type int64 = System.Int64<br /><br />Full name: Microsoft.FSharp.Core.int64<br />&#160;&#160;type: int64<br />&#160;&#160;inherits: System.ValueType<br /></div>
<div class="tip" id="ft22">val sqrt : &#39;T -&gt; &#39;U (requires member Sqrt)<br /><br />Full name: Microsoft.FSharp.Core.Operators.sqrt</div>
<div class="tip" id="ft23">Multiple items<br />val float : &#39;T -&gt; float (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.float<br /><br />--------------------<br />type float&lt;&#39;Measure&gt; = float<br /><br />Full name: Microsoft.FSharp.Core.float&lt;_&gt;<br />&#160;&#160;type: float&lt;&#39;Measure&gt;<br />&#160;&#160;inherits: System.ValueType<br /><br /><br />--------------------<br />type float = System.Double<br /><br />Full name: Microsoft.FSharp.Core.float<br />&#160;&#160;type: float<br />&#160;&#160;inherits: System.ValueType<br /></div>
<div class="tip" id="ft24">module Seq<br /><br />from Microsoft.FSharp.Collections</div>
<div class="tip" id="ft25">val forall : (&#39;T -&gt; bool) -&gt; seq&lt;&#39;T&gt; -&gt; bool<br /><br />Full name: Microsoft.FSharp.Collections.Seq.forall</div>
<div class="tip" id="ft26">val div : int64<br />&#160;&#160;type: int64<br />&#160;&#160;inherits: System.ValueType<br /></div>
<div class="tip" id="ft27">Multiple items<br />module List<br /><br />from Microsoft.FSharp.Collections<br /><br />--------------------<br />type List&lt;&#39;T&gt; =<br />&#160;&#160;| ( [] )<br />&#160;&#160;| ( :: ) of &#39;T * &#39;T list<br />&#160;&#160;with<br />&#160;&#160;&#160;&#160;interface System.Collections.IEnumerable<br />&#160;&#160;&#160;&#160;interface System.Collections.Generic.IEnumerable&lt;&#39;T&gt;<br />&#160;&#160;&#160;&#160;member Head : &#39;T<br />&#160;&#160;&#160;&#160;member IsEmpty : bool<br />&#160;&#160;&#160;&#160;member Item : index:int -&gt; &#39;T with get<br />&#160;&#160;&#160;&#160;member Length : int<br />&#160;&#160;&#160;&#160;member Tail : &#39;T list<br />&#160;&#160;&#160;&#160;static member Cons : head:&#39;T * tail:&#39;T list -&gt; &#39;T list<br />&#160;&#160;&#160;&#160;static member Empty : &#39;T list<br />&#160;&#160;end<br /><br />Full name: Microsoft.FSharp.Collections.List&lt;_&gt;<br />&#160;&#160;type: List&lt;&#39;T&gt;<br /></div>
<div class="tip" id="ft28">val map : (&#39;T -&gt; &#39;U) -&gt; &#39;T list -&gt; &#39;U list<br /><br />Full name: Microsoft.FSharp.Collections.List.map</div>
<div class="tip" id="ft29">type Tree&lt;&#39;T&gt; =<br />&#160;&#160;| Leaf of &#39;T<br />&#160;&#160;| Node of Tree&lt;&#39;T&gt; * Tree&lt;&#39;T&gt;<br /><br />Full name: TryJoinads.Tree&lt;_&gt;<br />&#160;&#160;type: Tree&lt;&#39;T&gt;<br /></div>
<div class="tip" id="ft30">union case Tree.Leaf: &#39;T -&gt; Tree&lt;&#39;T&gt;</div>
<div class="tip" id="ft31">union case Tree.Node: Tree&lt;&#39;T&gt; * Tree&lt;&#39;T&gt; -&gt; Tree&lt;&#39;T&gt;</div>
<div class="tip" id="ft32">val ballancedOfList : &#39;a list -&gt; Tree&lt;&#39;a&gt;<br /><br />Full name: TryJoinads.ballancedOfList<br /><em><br /><br />&#160;Creates a ballanced tree from a non-empty list<br />&#160;(odd elements are added to the left and even to the right)</em></div>
<div class="tip" id="ft33">Multiple items<br />val list : &#39;a list<br />&#160;&#160;type: &#39;a list<br /><br /><br />--------------------<br />type &#39;T list = List&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.list&lt;_&gt;<br />&#160;&#160;type: &#39;T list<br /></div>
<div class="tip" id="ft34">val failwith : string -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.Operators.failwith</div>
<div class="tip" id="ft35">val n : &#39;a</div>
<div class="tip" id="ft36">val left : (int * &#39;a) list<br />&#160;&#160;type: (int * &#39;a) list<br /></div>
<div class="tip" id="ft37">val right : (int * &#39;a) list<br />&#160;&#160;type: (int * &#39;a) list<br /></div>
<div class="tip" id="ft38">val mapi : (int -&gt; &#39;T -&gt; &#39;U) -&gt; &#39;T list -&gt; &#39;U list<br /><br />Full name: Microsoft.FSharp.Collections.List.mapi</div>
<div class="tip" id="ft39">val i : int<br />&#160;&#160;type: int<br />&#160;&#160;inherits: System.ValueType<br /></div>
<div class="tip" id="ft40">val v : &#39;a</div>
<div class="tip" id="ft41">val partition : (&#39;T -&gt; bool) -&gt; &#39;T list -&gt; &#39;T list * &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.List.partition</div>
<div class="tip" id="ft42">val left : &#39;a list<br />&#160;&#160;type: &#39;a list<br /></div>
<div class="tip" id="ft43">val right : &#39;a list<br />&#160;&#160;type: &#39;a list<br /></div>
<div class="tip" id="ft44">val snd : (&#39;T1 * &#39;T2) -&gt; &#39;T2<br /><br />Full name: Microsoft.FSharp.Core.Operators.snd</div>
<div class="tip" id="ft45">val primes : int64 list<br /><br />Full name: TryJoinads.primes<br />&#160;&#160;type: int64 list<br /></div>
<div class="tip" id="ft46">val v : int64<br />&#160;&#160;type: int64<br />&#160;&#160;inherits: System.ValueType<br /></div>
<div class="tip" id="ft47">val filter : (&#39;T -&gt; bool) -&gt; &#39;T list -&gt; &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.List.filter</div>
<div class="tip" id="ft48">val fst : (&#39;T1 * &#39;T2) -&gt; &#39;T1<br /><br />Full name: Microsoft.FSharp.Core.Operators.fst</div>
<div class="tip" id="ft49">val mixed : int64 list<br /><br />Full name: TryJoinads.mixed<br />&#160;&#160;type: int64 list<br /></div>
<div class="tip" id="ft50">val primeTree : Tree&lt;int64&gt;<br /><br />Full name: TryJoinads.primeTree<br />&#160;&#160;type: Tree&lt;int64&gt;<br /></div>
<div class="tip" id="ft51">val mixedTree : Tree&lt;int64&gt;<br /><br />Full name: TryJoinads.mixedTree<br />&#160;&#160;type: Tree&lt;int64&gt;<br /></div>
<div class="tip" id="ft52">val forall : (&#39;a -&gt; bool) -&gt; Tree&lt;&#39;a&gt; -&gt; bool<br /><br />Full name: TryJoinads.Parallel.forall<br /><em><br /><br />&#160;Checks whether the specified predicate &#39;f&#39;<br />&#160;holds for all Leaf elements of the tree.</em></div>
<div class="tip" id="ft53">val f : (&#39;a -&gt; bool)</div>
<div class="tip" id="ft54">val tree : Tree&lt;&#39;a&gt;<br />&#160;&#160;type: Tree&lt;&#39;a&gt;<br /></div>
<div class="tip" id="ft55">val loop : (Tree&lt;&#39;a&gt; -&gt; Task&lt;bool&gt;)</div>
<div class="tip" id="ft56">val left : Tree&lt;&#39;a&gt;<br />&#160;&#160;type: Tree&lt;&#39;a&gt;<br /></div>
<div class="tip" id="ft57">val right : Tree&lt;&#39;a&gt;<br />&#160;&#160;type: Tree&lt;&#39;a&gt;<br /></div>
<div class="tip" id="ft58">val l : bool<br />&#160;&#160;type: bool<br />&#160;&#160;inherits: System.ValueType<br /></div>
<div class="tip" id="ft59">val r : bool<br />&#160;&#160;type: bool<br />&#160;&#160;inherits: System.ValueType<br /></div>
<div class="tip" id="ft60">val forall : (&#39;a -&gt; bool) -&gt; Tree&lt;&#39;a&gt; -&gt; bool<br /><br />Full name: TryJoinads.Shortcircuiting.forall<br /><em><br /><br />&#160;Behaves like previous &#39;forall&#39; function, but returns<br />&#160;immediately when one of the branches returns &#39;false&#39;</em></div>
<div class="tip" id="ft61">val cts : CancellationTokenSource<br />&#160;&#160;type: CancellationTokenSource<br /></div>
<div class="tip" id="ft62">type CancellationTokenSource =<br />&#160;&#160;class<br />&#160;&#160;&#160;&#160;interface System.IDisposable<br />&#160;&#160;&#160;&#160;new : unit -&gt; CancellationTokenSource<br />&#160;&#160;&#160;&#160;member Cancel : unit -&gt; unit<br />&#160;&#160;&#160;&#160;member Dispose : unit -&gt; unit<br />&#160;&#160;&#160;&#160;member Token : CancellationToken<br />&#160;&#160;&#160;&#160;static member CreateLinkedTokenSource : token1:CancellationToken * token2:CancellationToken -&gt; CancellationTokenSource<br />&#160;&#160;end<br /><br />Full name: System.Threading.CancellationTokenSource<br />&#160;&#160;type: CancellationTokenSource<br /></div>
<div class="tip" id="ft63">property CancellationTokenSource.Token: CancellationToken</div>
<div class="tip" id="ft64">property CancellationToken.IsCancellationRequested: bool</div>
<div class="tip" id="ft65">val res : bool<br />&#160;&#160;type: bool<br />&#160;&#160;inherits: System.ValueType<br /></div>
<div class="tip" id="ft66">member CancellationTokenSource.Cancel : unit -&gt; unit</div>




<div class="row">
	<div class="small-4 columns">&#160;</div>
  <div class="small-8 columns">

<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style addthis_16x16_style">
<a class="addthis_button_twitter"></a>
<a class="addthis_button_reddit"></a>
<a class="addthis_button_google_plusone_share"></a>
<a class="addthis_button_hackernews"></a>
<a class="addthis_button_facebook"></a>
<a class="addthis_button_compact"></a><a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript">var addthis_config = { "data_track_addressbar": false };</script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-521c32162e6001a0"></script>
<!-- AddThis Button END -->

<p class="post-meta">
  <span><strong>Published</strong>: Friday, 17 February 2012, 1:10 PM</span><br />      
  <span class="tags"><strong>Tags</strong>: Research,F# language,Parallel,Joinads</span>
</p>

  </div>
</div>

    </content>

  </div>
  <div class="large-4 columns" id="right-bar">
    <div class="right-item" id="right-calendar">
      <script type="text/javascript">
        var monthNames =
          ["January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"];
        var d = new Date();
        var m = monthNames[d.getMonth()];
        var y = d.getFullYear();
        var ml = m.toLowerCase();
        document.writeln("<h4>Calendar - " + m + " " + y + "</h4>");
        document.writeln("<a href=\"http://tomasp.net/calendar/" + y + "/" + ml + ".html\">" +
          "<img src=\"http://tomasp.net/calendar/" + y + "/" + ml + "-preview.jpg\" style=\"border-style:none;\" />" +
          "</a>");
      </script> 
      <p>The calendar shows a new picture each month since 
        <a href="http://tomasp.net/calendar/2005">2005</a>, <a href="http://tomasp.net/calendar/2006">2006</a>, 
        <a href="http://tomasp.net/calendar/2007">2007</a>, <a href="http://tomasp.net/calendar/2008">2008</a>, 
        <a href="http://tomasp.net/calendar/2009">2009</a>, <a href="http://tomasp.net/calendar/2010">2010</a>, 
        <a href="http://tomasp.net/calendar/2011">2011</a>, <a href="http://tomasp.net/calendar/2012">2012</a>. <br />
        See the first photos of <a href="http://tomasp.net/calendar/2013">2013</a>.
      </p>
    </div>

    <h3>Welcome!</h3>
    <img src="http://tomasp.net/img/tomas.jpg" alt="Tomas Petricek" style="float:right;margin:10px 0px 10px 10px;" />
    <p>I'm an F# enthusiast, book author and a PhD student at the University of Cambridge.
      When offline, I enjoy traveling and taking pictures. You can find me at
      at <a href="http://twitter.com/tomaspetricek">@tomaspetricek</a> or email 
      <a href="mailto:tomas@tomasp.net">tomas@tomasp.net</a>.
    </p>

    <script type="text/javascript" src="http://tomasp.net/news/news.js"></script>
    <h4>What's new? &#160; <small><script type="text/javascript">document.write(news.date)</script></small></h4>
    <script>
      document.write(news.info);
    </script>

    <h4>Trainings and consulting</h4>
    <img src="http://tomasp.net/img/skillsmatter.png" alt="Tomas Petricek" style="float:right;margin:15px 0px 10px 10px;" />
    <p>I run F# and functional programming courses in <strong>London</strong>
      and <strong>New York</strong> with SkillsMatter.
    </p>
    <ul>
      <li>Check out our <a href="http://skillsmatter.com/course/scala/tomas-petricek-phil-trelford-fast-track-to-fsharp/ps-6679">Fast Track to F#</a> course</li>
      <li><a href="mailto:tomas@tomasp.net">Email me</a> for info about private trainings</li>
    </ul>
    
    <h4>F# Books and articles</h4>
    <div style="float:right;">
      <a href="http://www.amazon.com/gp/product/1933988924/ref=as_li_tf_il?ie=UTF8&amp;tag=httptomasnet-20&amp;linkCode=as2&amp;camp=217145&amp;creative=399369&amp;creativeASIN=1933988924">
        <img src="http://tomasp.net/img/rwfp.jpg" alt="Real World Functional Programming" style="float:right;margin:10px 0px 10px 10px;border-style:none;" />
      </a>
    </div>
    <p><a href="http://www.manning.com/petricek">Real World Functional Programming</a> explains functional
      concepts using F# and C#. You can get it from <a href="http://www.amazon.com/dp/1933988924?tag=httptomasnet-20&amp;camp=213381&amp;creative=390973&amp;linkCode=as4&amp;creativeASIN=1933988924&amp;adid=0F1DP260JGG4KY0CDGP6">Amazon.com</a>, <a href="https://www.amazon.co.uk/dp/1933988924?tag=tomasnet-21&amp;camp=1406&amp;creative=6394&amp;linkCode=as1&amp;creativeASIN=1933988924&amp;adid=1CTY87YCCQEJW965GNDF">Amazon.co.uk</a> or your favorite book store.
      Some chapters and new materials are also available on <a href="http://msdn.microsoft.com/en-us/library/hh314518.aspx">MSDN</a>.</p>
    
    <p>Currently, I'm putting together <a href="http://www.manning.com/petricek2/">F# Deep Dives</a> - a collection
      of practical F# essays written by community leaders and commercial users of F#.</p>
    <p>I also wrote a series of tutorials on <a href="http://www.tryfsharp.org/Learn/financial-computing">financial computing</a>
      for Try F# - an interactive environment that let's you try F# in the browser.</p>

    <h4>Research and teaching</h4>
    <img src="http://tomasp.net/img/cam.png" alt="University of Cambride" style="float:right;margin:25px 0px 10px 10px;" />
    <p>I'm finishing PhD in computer science at the <a href="http://www.cl.cam.ac.uk/">University of Cambridge</a>.
      I'm working on making better types for programs that run in rich context (like F# type providers, distributed 
      prog&shy;ramming or data-flow). See <a href="http://www.cl.cam.ac.uk/~tp322/">my academic page</a> for
      more.</p>

    <h4>Blog tags</h4>
    <p>

      <a href="http://tomasp.net/blog/tag/fsharp/">f#</a>&nbsp;(86),       <a href="http://tomasp.net/blog/tag/functional/">functional</a>&nbsp;(63),       <a href="http://tomasp.net/blog/tag/research/">research</a>&nbsp;(25),       <a href="http://tomasp.net/blog/tag/writing/">writing</a>&nbsp;(11),       <a href="http://tomasp.net/blog/tag/csharp/">c#</a>&nbsp;(29),       <a href="http://tomasp.net/blog/tag/links/">links</a>&nbsp;(15),       <a href="http://tomasp.net/blog/tag/presentations/">presentations</a>&nbsp;(14),       <a href="http://tomasp.net/blog/tag/haskell/">haskell</a>&nbsp;(6),       <a href="http://tomasp.net/blog/tag/talks/">talks</a>&nbsp;(2),       <a href="http://tomasp.net/blog/tag/new-york/">new york</a>&nbsp;(2),       <a href="http://tomasp.net/blog/tag/manning/">manning</a>&nbsp;(2),       <a href="http://tomasp.net/blog/tag/books/">books</a>&nbsp;(2),       <a href="http://tomasp.net/blog/tag/open-source/">open source</a>&nbsp;(2),       <a href="http://tomasp.net/blog/tag/training/">training</a>&nbsp;(1),       <a href="http://tomasp.net/blog/tag/deep-dives/">deep dives</a>&nbsp;(1),       <a href="http://tomasp.net/blog/tag/functional-programming/">functional programming</a>&nbsp;(1),       <a href="http://tomasp.net/blog/tag/async/">async</a>&nbsp;(1),       <a href="http://tomasp.net/blog/tag/fsharp-data/">f# data</a>&nbsp;(1),       <a href="http://tomasp.net/blog/tag/type-providers/">type providers</a>&nbsp;(1),       <a href="http://tomasp.net/blog/tag/events/">events</a>&nbsp;(1)    </p>

  </div>
</div>


  <div class="row" id="footer">
  <footer>   
    <div class="large-3 columns">
      <h4>Contact &amp; about</h4>
      <p>This site is hosted on GitHub and is generated using <a href="https://github.com/tpetricek/FSharp.Formatting">F# Formatting</a>.
        For more info, see the <a href="https://github.com/tpetricek/TomaspNet.Website">website source on GitHub</a>.
      </p>
      <p>Please submit issues &amp; corrections on GitHub. Use pull requests for minor corrections only.</p>
      <ul>
        <li>Email me: <a href="mailto:tomas@tomasp.net">tomas@tomasp.net</a></li>
        <li>Connect via Twitter: <a href="http://twitter.com/tomaspetricek">@tomaspetricek</a></li>
        <li>More: <a href="http://uk.linkedin.com/in/tomaspetricek">LinkedIn</a> | <a href="http://lanyrd.com/profile/tomasp/">Lanyrd</a> | <a href="https://github.com/tpetricek">GitHub</a></li>
      </ul>
    </div>
    <div class="large-7 columns">
    <h4>Blog archives <a href="http://tomasp.net/rss.xml"><img src="http://tomasp.net/img/rss.gif" /></a></h4>
      <a href="http://tomasp.net/blog/archive/august-2013/index.html">
        August 2013 (2)</a>,      <a href="http://tomasp.net/blog/archive/may-2013/index.html">
        May 2013 (1)</a>,      <a href="http://tomasp.net/blog/archive/april-2013/index.html">
        April 2013 (1)</a>,      <a href="http://tomasp.net/blog/archive/march-2013/index.html">
        March 2013 (1)</a>,      <a href="http://tomasp.net/blog/archive/february-2013/index.html">
        February 2013 (1)</a>,      <a href="http://tomasp.net/blog/archive/january-2013/index.html">
        January 2013 (1)</a>,      <a href="http://tomasp.net/blog/archive/december-2012/index.html">
        December 2012 (2)</a>,      <a href="http://tomasp.net/blog/archive/october-2012/index.html">
        October 2012 (1)</a>,      <a href="http://tomasp.net/blog/archive/august-2012/index.html">
        August 2012 (3)</a>,      <a href="http://tomasp.net/blog/archive/june-2012/index.html">
        June 2012 (2)</a>,      <a href="http://tomasp.net/blog/archive/april-2012/index.html">
        April 2012 (1)</a>,      <a href="http://tomasp.net/blog/archive/march-2012/index.html">
        March 2012 (4)</a>,      <a href="http://tomasp.net/blog/archive/february-2012/index.html">
        February 2012 (5)</a>,      <a href="http://tomasp.net/blog/archive/january-2012/index.html">
        January 2012 (2)</a>,      <a href="http://tomasp.net/blog/archive/november-2011/index.html">
        November 2011 (5)</a>,      <a href="http://tomasp.net/blog/archive/august-2011/index.html">
        August 2011 (3)</a>,      <a href="http://tomasp.net/blog/archive/july-2011/index.html">
        July 2011 (2)</a>,      <a href="http://tomasp.net/blog/archive/june-2011/index.html">
        June 2011 (2)</a>,      <a href="http://tomasp.net/blog/archive/may-2011/index.html">
        May 2011 (2)</a>,      <a href="http://tomasp.net/blog/archive/march-2011/index.html">
        March 2011 (4)</a>,      <a href="http://tomasp.net/blog/archive/december-2010/index.html">
        December 2010 (1)</a>,      <a href="http://tomasp.net/blog/archive/november-2010/index.html">
        November 2010 (6)</a>,      <a href="http://tomasp.net/blog/archive/october-2010/index.html">
        October 2010 (6)</a>,      <a href="http://tomasp.net/blog/archive/september-2010/index.html">
        September 2010 (4)</a>,      <a href="http://tomasp.net/blog/archive/july-2010/index.html">
        July 2010 (3)</a>,      <a href="http://tomasp.net/blog/archive/june-2010/index.html">
        June 2010 (2)</a>,      <a href="http://tomasp.net/blog/archive/may-2010/index.html">
        May 2010 (1)</a>,      <a href="http://tomasp.net/blog/archive/february-2010/index.html">
        February 2010 (2)</a>,      <a href="http://tomasp.net/blog/archive/january-2010/index.html">
        January 2010 (3)</a>,      <a href="http://tomasp.net/blog/archive/december-2009/index.html">
        December 2009 (3)</a>,      <a href="http://tomasp.net/blog/archive/july-2009/index.html">
        July 2009 (1)</a>,      <a href="http://tomasp.net/blog/archive/june-2009/index.html">
        June 2009 (3)</a>,      <a href="http://tomasp.net/blog/archive/may-2009/index.html">
        May 2009 (2)</a>,      <a href="http://tomasp.net/blog/archive/april-2009/index.html">
        April 2009 (1)</a>,      <a href="http://tomasp.net/blog/archive/march-2009/index.html">
        March 2009 (2)</a>,      <a href="http://tomasp.net/blog/archive/february-2009/index.html">
        February 2009 (1)</a>,      <a href="http://tomasp.net/blog/archive/december-2008/index.html">
        December 2008 (1)</a>,      <a href="http://tomasp.net/blog/archive/november-2008/index.html">
        November 2008 (5)</a>,      <a href="http://tomasp.net/blog/archive/october-2008/index.html">
        October 2008 (1)</a>,      <a href="http://tomasp.net/blog/archive/september-2008/index.html">
        September 2008 (1)</a>,      <a href="http://tomasp.net/blog/archive/june-2008/index.html">
        June 2008 (1)</a>,      <a href="http://tomasp.net/blog/archive/march-2008/index.html">
        March 2008 (3)</a>,      <a href="http://tomasp.net/blog/archive/february-2008/index.html">
        February 2008 (1)</a>,      <a href="http://tomasp.net/blog/archive/december-2007/index.html">
        December 2007 (2)</a>,      <a href="http://tomasp.net/blog/archive/november-2007/index.html">
        November 2007 (6)</a>,      <a href="http://tomasp.net/blog/archive/october-2007/index.html">
        October 2007 (1)</a>,      <a href="http://tomasp.net/blog/archive/september-2007/index.html">
        September 2007 (1)</a>,      <a href="http://tomasp.net/blog/archive/august-2007/index.html">
        August 2007 (1)</a>,      <a href="http://tomasp.net/blog/archive/july-2007/index.html">
        July 2007 (2)</a>,      <a href="http://tomasp.net/blog/archive/april-2007/index.html">
        April 2007 (2)</a>,      <a href="http://tomasp.net/blog/archive/march-2007/index.html">
        March 2007 (3)</a>,      <a href="http://tomasp.net/blog/archive/february-2007/index.html">
        February 2007 (3)</a>,      <a href="http://tomasp.net/blog/archive/january-2007/index.html">
        January 2007 (2)</a>,      <a href="http://tomasp.net/blog/archive/november-2006/index.html">
        November 2006 (1)</a>,      <a href="http://tomasp.net/blog/archive/october-2006/index.html">
        October 2006 (3)</a>,      <a href="http://tomasp.net/blog/archive/august-2006/index.html">
        August 2006 (2)</a>,      <a href="http://tomasp.net/blog/archive/july-2006/index.html">
        July 2006 (1)</a>,      <a href="http://tomasp.net/blog/archive/june-2006/index.html">
        June 2006 (3)</a>,      <a href="http://tomasp.net/blog/archive/may-2006/index.html">
        May 2006 (2)</a>,      <a href="http://tomasp.net/blog/archive/april-2006/index.html">
        April 2006 (2)</a>,      <a href="http://tomasp.net/blog/archive/december-2005/index.html">
        December 2005 (1)</a>,      <a href="http://tomasp.net/blog/archive/july-2005/index.html">
        July 2005 (4)</a>,      <a href="http://tomasp.net/blog/archive/june-2005/index.html">
        June 2005 (5)</a>,      <a href="http://tomasp.net/blog/archive/may-2005/index.html">
        May 2005 (1)</a>,      <a href="http://tomasp.net/blog/archive/april-2005/index.html">
        April 2005 (3)</a>,      <a href="http://tomasp.net/blog/archive/march-2005/index.html">
        March 2005 (3)</a>,      <a href="http://tomasp.net/blog/archive/january-2005/index.html">
        January 2005 (1)</a>,      <a href="http://tomasp.net/blog/archive/december-2004/index.html">
        December 2004 (3)</a>,      <a href="http://tomasp.net/blog/archive/november-2004/index.html">
        November 2004 (2)</a>,    </div>
    <div class="large-2 columns">
      <h4>License</h4>
      <p>Unless explicitly mentioned, all articles on this site are licensed under <a href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution Share Alike</a>. 
        All source code samples are licensed under Apache 2.0.
      </p>
      <img src="http://tomasp.net/img/cc-sa.png" alt="CC License logo" />
    </div>
  </footer>
  </div>
  
  <script>
  document.write('<script src=' +
  ('__proto__' in {} ? 'http://tomasp.net/js/vendor/zepto' : 'http://tomasp.net/js/vendor/jquery') +
  '.js><\/script>')
  </script>
  
  <script src="http://tomasp.net/js/foundation.min.js"></script>
  <script>
    $(document).foundation();
  </script>
  <script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1561220-1']);
    _gaq.push(['_trackPageview']);

    (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

  </script>
</body>
</html>